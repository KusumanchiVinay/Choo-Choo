<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choo Choo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <header>
        <div class="logo">
            <a href="/hom">
                <img src="/static/logo.jpg" alt="Logo">
            </a>
            <h2>Choo Choo</h2>
        </div>

        <div class="profile-dropdown">
            <button class="profile-btn" id="profile-btn">Guest</button>
            <div class="dropdown-content" id="dropdown-content">
                <a href="/login" id="login-link">Login</a>
                <a href="/signup" id="signup-link">Sign Up</a>
                <a href="/logout" id="logout-link" style="display:none;">Logout</a>
                <a href="/new-chat" id="new-chat-link" style="display:none;">New Chat</a>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar with Chat History -->
        <div class="sidebar" id="sidebar" style="display:none;">
            <div class="chat-history" id="chat-history">
                <div class="chathistory-h3">
                    <h3>Chat History</h3>
                </div>
                <button class="new-chat-btn" id="new-chat-btn">+ New Chat</button>
                <div class="history-container">
                    <ul id="history-list"></ul>
                </div>
            </div>
            <button id="toggle-history-btn" class="hamburger-btn">
                â˜°
            </button>
        </div>

        <!-- Guest Mode Banner -->
        <div id="guest-banner" class="guest-banner" style="display:none;">
            <p>ðŸ’¬ You're in <strong>Guest Mode</strong> - Chat freely but messages won't be saved.</p>
            <a href="/login"><button>Login to Save History</button></a>
        </div>
        
        <!-- Chat Container Section -->
        <div class="chat-container">
            <div id="messages"></div>
            <div id="input-container">
                <input type="text" id="user-input" placeholder="I'm here to help! Ask me anything.">
                <button id="send-button">Send</button>
                <button id="microphone">ðŸŽ™</button>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const microphoneButton = document.getElementById('microphone');
        const toggleHistoryBtn = document.getElementById('toggle-history-btn');
        const chatHistory = document.getElementById('chat-history');
        const newChatBtn = document.getElementById('new-chat-btn');
        const sidebar = document.getElementById('sidebar');
        const profileBtn = document.getElementById('profile-btn');
        const dropdownContent = document.getElementById('dropdown-content');
        const guestBanner = document.getElementById('guest-banner');

        let isListening = false;
        let activeSessionId = null;
        let currentUtterance = null;
        let isSpeaking = false;
        let isGuest = true;

        function stopCurrentSpeech() {
            if ('speechSynthesis' in window && currentUtterance) {
                speechSynthesis.cancel();
                currentUtterance = null;
                isSpeaking = false;
            }
        }

        function addMessage(text, sender, autoSpeak = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            
            const messageDiv = document.createElement('div');
            messageDiv.textContent = text;
            messageElement.appendChild(messageDiv);

            if (sender === 'bot') {
                const speakBtn = document.createElement('button');
                speakBtn.innerHTML = 'ðŸŽµ';
                speakBtn.classList.add('speak-btn');
                speakBtn.title = 'Click to hear the response';

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;

                utterance.onend = () => {
                    isSpeaking = false;
                    speakBtn.innerHTML = 'ðŸŽµ';
                };

                speakBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (!isSpeaking) {
                        stopCurrentSpeech();
                        currentUtterance = utterance;
                        isSpeaking = true;
                        speechSynthesis.speak(utterance);
                        speakBtn.innerHTML = 'â¸ï¸';
                    } else {
                        stopCurrentSpeech();
                        speakBtn.innerHTML = 'ðŸŽµ';
                    }
                };

                if (autoSpeak) {
                    stopCurrentSpeech();
                    currentUtterance = utterance;
                    isSpeaking = true;
                    speechSynthesis.speak(utterance);
                    speakBtn.innerHTML = 'â¸ï¸';
                }

                messageElement.appendChild(speakBtn);
            }

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function handleSend() {
            const text = userInput.value.trim();
            if (text) {
                stopCurrentSpeech();
                addMessage(text, 'user');
                userInput.value = '';
                
                try {
                    const response = await fetch('/api/typed-input', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text, sessionId: activeSessionId })
                    });
                    
                    if (!response.ok) {
                        addMessage('Error: Could not process your request', 'bot');
                        return;
                    }
                    
                    const data = await response.json();
                    addMessage(data.response, 'bot', true);

                    if (data.updated_title && !isGuest) {
                        updateChatTitle(data.updated_title);
                        await fetchChatHistory();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('Network error. Please try again.', 'bot');
                }
            }
        }

        function updateChatTitle(firstMessage) {
            const historyItems = document.querySelectorAll('#history-list li');
            if (historyItems.length > 0) {
                const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
                historyItems[0].textContent = title;
            }
        }

        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleSend();
            }
        });

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.language = 'en-US';

        recognition.onstart = () => {
            isListening = true;
            userInput.placeholder = 'ðŸŽ™ Listening...';
            userInput.disabled = true;
            microphoneButton.innerHTML = 'â¹';
        };

        recognition.onend = () => {
            isListening = false;
            userInput.placeholder = "I'm here to help! Ask me anything.";
            userInput.disabled = false;
            microphoneButton.innerHTML = 'ðŸŽ™';
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            addMessage(`Sorry, I couldn't understand. Error: ${event.error}`, 'bot');
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    userInput.value = transcript;
                    handleSend();
                } else {
                    interimTranscript += transcript;
                }
            }
            if (interimTranscript) {
                userInput.placeholder = `Interim: ${interimTranscript}`;
            }
        };

        microphoneButton.addEventListener('click', () => {
            if (!isListening) {
                recognition.start();
            } else {
                recognition.stop();
            }
        });

        async function fetchChatHistory() {
            try {
                const response = await fetch('/api/chat-history');
                if (!response.ok) return;
                
                const data = await response.json();
                if (data.is_guest) {
                    sidebar.style.display = 'none';
                    guestBanner.style.display = 'block';
                    return;
                }

                const historyList = document.getElementById('history-list');
                
                if (historyList) {
                    historyList.innerHTML = '';
                    if (data.chat_history && data.chat_history.length > 0) {
                        data.chat_history.forEach(chat => {
                            const li = document.createElement('li');
                            li.dataset.sessionId = chat.chat_session_id;
                            
                            const chatTitle = document.createElement('span');
                            chatTitle.textContent = chat.title;
                            chatTitle.style.flex = '1';
                            chatTitle.style.cursor = 'pointer';
                            chatTitle.onclick = () => loadChat(chat.chat_session_id);
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'ðŸ—‘';
                            deleteBtn.classList.add('delete-chat-btn');
                            deleteBtn.title = 'Delete this chat';
                            deleteBtn.onclick = (e) => {
                                e.stopPropagation();
                                deleteChat(chat.chat_session_id);
                            };
                            
                            li.appendChild(chatTitle);
                            li.appendChild(deleteBtn);
                            historyList.appendChild(li);
                        });
                    }
                }
            } catch (error) {
                console.error('Error fetching chat history:', error);
            }
        }

        async function loadChat(sessionId) {
            activeSessionId = sessionId;
            messagesContainer.innerHTML = '';
            
            try {
                const response = await fetch(`/api/get-chat/${sessionId}`);
                if (!response.ok) return;
                
                const chatSession = await response.json();
                chatSession.messages.forEach(msg => {
                    addMessage(msg.user.text, 'user');
                    addMessage(msg.bot.text, 'bot');
                });
                
                document.querySelectorAll('#history-list li').forEach(li => {
                    li.classList.remove('active');
                    if (li.dataset.sessionId === sessionId) {
                        li.classList.add('active');
                    }
                });
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        async function deleteChat(sessionId) {
            if (!confirm('Delete this chat? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delete-chat/${sessionId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    alert('Failed to delete chat');
                    return;
                }
                
                // If deleting the current chat, create new one
                if (sessionId === activeSessionId) {
                    await createNewChat();
                } else {
                    // Just refresh the history
                    await fetchChatHistory();
                }
            } catch (error) {
                console.error('Error deleting chat:', error);
                alert('Error deleting chat');
            }
        }

        async function createNewChat() {
            try {
                // Check if current chat is empty - if so, don't create new one
                if (!isGuest && activeSessionId && messagesContainer.children.length === 0) {
                    // Current chat is already empty, just reload it
                    return;
                }
                
                const response = await fetch('/api/new-session', { method: 'POST' });
                if (!response.ok) return;
                
                const data = await response.json();
                activeSessionId = data.chat_session_id;
                messagesContainer.innerHTML = '';
                if (!data.is_guest) {
                    await fetchChatHistory();
                }
            } catch (error) {
                console.error('Error creating new chat:', error);
            }
        }

        toggleHistoryBtn.addEventListener('click', () => {
            chatHistory.classList.toggle('show');
        });

        newChatBtn.addEventListener('click', createNewChat);

        profileBtn.addEventListener('click', function() {
            dropdownContent.classList.toggle('show');
        });

        window.onclick = function(event) {
            if (!event.target.matches('.profile-btn')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                Array.from(dropdowns).forEach(function(openDropdown) {
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                });
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const emailResponse = await fetch('/api/get-email');
                if (emailResponse.ok) {
                    const { email, is_guest } = await emailResponse.json();
                    isGuest = is_guest;
                    
                    if (!is_guest) {
                        const initials = email.substring(0, 2).toUpperCase();
                        profileBtn.textContent = initials;
                        sidebar.style.display = 'flex';
                        guestBanner.style.display = 'none';
                        document.getElementById('login-link').style.display = 'none';
                        document.getElementById('signup-link').style.display = 'none';
                        document.getElementById('logout-link').style.display = 'block';
                        document.getElementById('new-chat-link').style.display = 'block';
                        await fetchChatHistory();
                    } else {
                        profileBtn.textContent = 'Guest';
                        sidebar.style.display = 'none';
                        guestBanner.style.display = 'block';
                        document.getElementById('login-link').style.display = 'block';
                        document.getElementById('signup-link').style.display = 'block';
                        document.getElementById('logout-link').style.display = 'none';
                        document.getElementById('new-chat-link').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking email:', error);
            }
            
            await createNewChat();
        });
    </script>
</body>
</html>
